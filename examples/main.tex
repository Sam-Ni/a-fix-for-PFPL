\documentclass{article}
\usepackage{times, url}
\usepackage[english]{babel}
\usepackage{amsmath,amsthm,amssymb}
\usepackage{proof}
\usepackage{tikz-cd}
\usetikzlibrary{shapes.geometric}

\newtheorem{lemma}{Lemma}
\newtheorem{definition}{Definition}
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}{Corollary}
\newtheorem{proposition}{Proposition}

\newcommand{\RNum}[1]{\uppercase\expandafter{\romannumeral #1\relax}}
 
\begin{document}
 
% --------------------------------------------------------------
%                         Start here
% --------------------------------------------------------------
 
%\renewcommand{\qedsymbol}{\filledbox}

\newcommand{\fix}[2]{\mathrm{fix}^{#1}\;x:\tau\;\mathrm{is}\;\mathit{#2}}
\newcommand{\afix}[3]{#1\{\fix{#2}{#3}\}}
 
\title{A Fix for the Proof of \\
  Fixed Point Induction in PFPL}
\author{Yicheng Ni \and Yuting Wang}
 
\maketitle

\section{Introduction}

We are building a Coq library for reasoning about the locally nameless
representation based on the locally nameless sets proposed by Andrew Pitts.
When we are formalizing in Coq the theory about equational reasoning in
Practical Foundations for Programming Languages (PFPL),
we find the proof of a theorem in the book problematic.

To be more specific, the proof of
reflexivity of logical equivalence for PCF (also known as the fundamental theorem) in Chapter 47 depends on a theorem called Fixed Point Induction (Theorem 47.8 in PFPL).
The proof of Fixed Point Induction
does not encompass all possible cases, making the proof incomplete.
% The problem is that the proof of Fixed Point Induction is not complete in the sense that
% some cases were not discussed in the book.

The rest of this note discusses a solution to this problem. It is
organized as follows.  We first reiterate related definitions and
notations in PFPL in Section~\ref{sec:def}.  We state the problem in more
detail in Section~\ref{sec:problem}.  We then try a fix suggested by
the author of PFPL and illustrate where we got stuck in Section~\ref{sec:sug}.
Finally, we propose our solution in Section~\ref{sec:solution}.

\section{Definitions}
\label{sec:def}

We try to keep the definitions and notations the same as those in PFPL.

\begin{definition}[Kleene equality]
  Two terms $e$ and $e'$ are kleene equal, written as $e\simeq e'$,
  iff for every $n\ge 0$, $e\longmapsto_*\overline{n}$ iff $e'\longmapsto_*\overline{n}$.
  where $\longmapsto_*$ is the transitive closure of the small-step reduction.
\end{definition}

By this definition, two terms are kleene equal iff they converge to
the same value or they both diverge.

\begin{definition}[Logical equivalence]
  A logical equivalence $e\sim_{\tau} e'$ between closed expressions of type $\tau$
  is defined by induction on $\tau$ as follows:

  \begin{center}
    \begin{tabular}{lll}
      $e\sim_{\textit{nat}}e'$ & iff & $e\simeq e'$ \\
      $e\sim_{\tau_1\rightharpoonup\tau_2}e'$ & iff & $e_1 \sim_{\tau_1}e_1'$ implies $e(e_1)\sim_{\tau_2}e'(e_1')$.
    \end{tabular}
  \end{center}

\end{definition}

\begin{definition}[General recursion]
  The construct of general recursion (fixed point) in PCF is written as $\fix{}{e}$.
\end{definition}

The reduction rule of general recursion is defined as follows:

\begin{center}
  $\fix{}{e}\longmapsto [\fix{}{e}/x]e$.
\end{center}

\begin{definition}[Bounded recursion]
  A bounded recursion $\fix{m}{e}$ is defined by induction on $m\ge 0$ as follows:

  \begin{center}
    $\fix{0}{e}\triangleq\fix{}{x}$ \\
    $\fix{m+1}{e}\triangleq[\fix{m}{e}/x]e$.
  \end{center}
\end{definition}

PFPL employs the following notations: $f^{(\omega)}\triangleq \fix{}{e_x}$ and $f^{(m)}\triangleq \fix{m}{e_x}$ for some given $e_x$ in the context.

% \begin{tabular}{c|l}
%   $\simeq$ & kleene equality \\
%   $\sim_{\tau}$ & logical equivalence \\
%   $f^{(w)}$ & $\fix{}{ex}$ \\
%   $f^{(m)}$ & the m-bounded recursion of $f^{(w)}$
% \end{tabular}

\section{Problem}
\label{sec:problem}


The problem lies in the proof of Fixed Point Induction,
which is stated as follows:

\begin{theorem}[Fixed Point Induction] \label{thm:fpi}
  Suppose that $x:\tau\vdash e:\tau$. \\
  If $(\forall m\ge 0)\;\fix{m}{e} \sim_{\tau} \fix{m}{e'}$,
  then $\fix{}{e}\sim_{\tau}\fix{}{e'}$.
\end{theorem}

By Fixed Point Induction, if for any $m$ the $m$-bounded recursion of two terms are logically equivalent,
then the general recursion of these two terms are logically equivalent.
To prove this theorem, PFPL introduces applicative contexts and tries to prove a Generalized Fixed Point Induction theorem.
A context is a term with a hole to be filled with another term.
The notation $\afix{A}{}{e}$ denotes a term generated by filling the context $A$ with term $\fix{}{e}$.
The definition of applicative contexts can be found in the book which we do not repeat here.
The important point about applicative contexts for this note is that $\afix{A}{}{e}$ is equal to $[\fix{}{e}/y](A\{y\})$,
where $y$ is a fresh variable.

The Generalized Fixed Point Induction theorem is stated as follows:

\begin{theorem}[Generalized Fixed Point Induction]
  \;\\
  If $(\forall m\ge 0)\;\afix{A}{m}{e} \sim_{\tau_0} \afix{A'}{m}{e'}$,
  then $\afix{A}{}{e}\sim_{\tau_0}\afix{A'}{}{e'}$.
\end{theorem}

If Generalized Fixed Point Induction holds, then we can derive the original Fixed Point Induction theorem by
instantiating $A$ and $A'$ with the empty context.

The generalized theorem is proved by induction on the structure of type $\tau_0$.
However, we got stuck at the base case where $\tau_0$ is $\mathit{nat}$.
According to the definition of $\sim_{\textit{nat}}$,
we have to show $\afix{A}{}{e} \simeq \afix{A'}{}{e'}$.
Here, PFPL introduces a lemma (which is Corollary 47.17 in PFPL):

\begin{lemma}\label{cor:com}
  Suppose that $y:\tau\vdash e:\textit{nat}$.
  There exists $m\ge 0$ such that $[f^{(\omega)}/y]e \simeq [f^{(m)}/y]e$.
  % where $f^{(\omega)}\triangleq \fix{}{e_x}$ and $f^{(m)}\triangleq \fix{m}{e_x}$ for any $e_x$.
\end{lemma}

Lemma~\ref{cor:com} is a corollary
of the Compactness theorem (Theorem 47.16 in PFPL).
In the original proof, Lemma~\ref{cor:com} is applied twice in the proof of Generalized Fixed Point Induction:
first instantiating $e$ in Lemma~\ref{cor:com} with $A\{y\}$ to get some $m_1$ such that $\afix{A}{}{e} \simeq \afix{A}{m_1}{e}$
and second instantiating $e$ with $A'\{y\}$ to get some $m_2$ such that $\afix{A'}{m_2}{e'} \simeq \afix{A'}{}{e'}$.
The proof can be concluded by the transitivity of $\simeq$ if $\afix{A}{m_1}{e} \simeq \afix{A'}{m_2}{e'}$ holds.
This can be derived from the assumption when $m_1=m_2$.
However, it is not clear what we should do if $m_1 \neq m_2$.

\section{An Attempt to Fix this Problem}
\label{sec:sug}

To fix the above proof, one may consider picking the larger number
from $m_1$ and $m_2$ and pumping the smaller bounded fixed point in
the given proposition to match the larger one.\footnote{Based on a
discussion with the author of PFPL through email.}  For example, the above
proof can be finished if we can prove the following proposition:

\begin{proposition}\label{pro}
  If $[f^{(\omega)}/y]e \simeq [f^{(m)}/y]e$,
  then $\forall m'\ge m, [f^{(\omega)}/y]e \simeq [f^{(m')}/y]e$.
\end{proposition}

We tried to prove this proposition by case analysis on whether
$[f^{(\omega)}/y]e$ converges.
If $[f^{(\omega)}/y]e$ converges, the proposition can be proved by Lemma 47.15 in PFPL.
% The proposition holds if $[f^{(\omega)}/y]e$ converges (which is
% exactly Lemma 47.15 in PFPL).
However, we do not know how to prove
the proposition if $[f^{(\omega)}/y]e$ diverges.
Suppose $m = 0$ and $e = y$, we need to prove
$f^{(\omega)}\simeq f^{(m')}$ for all $m'\ge 0$.
We have the assumption that
$f^{(\omega)}\simeq f^{(0)}$ and both $f^{(0)}$ and $f^{(\omega)}$ diverge.
This assumption does not carry enough information for us to finish the proof. 
That is, to prove the divergence of general recursion implies the divergence of all bounded recursions.
% need to prove
% $f^{(\omega)}\simeq f^{(m')}$ for all $m'\ge 0$.
% For example, if $m =
% 0$ and $[f^{(\omega)}/y]e$ diverges, $[f^{(m)}/y]e$ diverges according
% to the assumption $[f^{(\omega)}/y]e \simeq [f^{(m)}/y]e$.  To prove
% $[f^{(\omega)}/y]e \simeq [f^{(m')}/y]e$, we need to show
% $[f^{(m')}/y]e$ also diverges. We are not clear how this can be proved
% (for instance, when $e = y$ we need to show $f^{(m')}$ diverges for
% all $m' \geq 0$ if $f^{(\omega)}$ diverges).

\section{Our Solution}
\label{sec:solution}

The problem of the proof for the Generalized Fixed Point Induction is
that Lemma~\ref{cor:com} was applied \emph{twice} which generates
incompatible assumptions. We propose a solution that applies
Lemma~\ref{cor:com} \emph{only once} and employs an inverse of the compactness
theorem to finish the proof. Below we discuss this solution in details.
The problem with the original proof is that the compactness theorem is applied twice which generates incompatible bounding numbers for recursion.

\begin{theorem}[Compactness]
  Suppose that $y:\tau\vdash e:\textit{nat}$ where $y\notin f^{(\omega)}$. \\
  If $[f^{(\omega)}/y]e\longmapsto_*\overline{n}$, then there exists some $m$ such that $[f^{(m)}/y]e\longmapsto_*\overline{n}$.
\end{theorem}

The Compactness theorem states that convergence of general recursion implies convergence of some bounded recursion.
To fix the proof for the Generalized Fixed Point Induction, we propose the Inverse of Compactness theorem:

\begin{lemma}[Inverse of Compactness] \label{lem:cc}
  Suppose that $y:\tau\vdash e:\textit{nat}$ where $y\notin f^{(\omega)}$.
  If $[f^{(m)}/y]e\longmapsto_*\overline{n}$ for some $m$, then $[f^{(\omega)}/y]e\longmapsto_*\overline{n}$.
\end{lemma}

It states that the convergence of bounded recursion implies the convergence of general recursion.
This theorem is the contrapositive proposition of the goal we got stuck in Section~\ref{sec:sug}.
In our proof for the Generalized Fixed Point Induction,
Compactness and the Inverse of Compactness theorem are both applied once.
Lemma~\ref{cor:com}, which is applied twice in the original proof of Generalized Fixed Point Induction in PFPL,
is unnecessary in our proof since we directly perform case analysis on the divergence of terms.
In the rest of this section, we first repair the Generalized Fixed Point Induction in \ref{subsec:repair}
and then prove Inverse of Compactness theorem in \ref{subsec:inverse}.

\subsection{Repair of the Generalized Fixed Point Induction}
\label{subsec:repair}

Recall that the Generalized Fixed Point Induction is proved by
induction on the type $\tau$.
In the base case where $\tau=\textit{nat}$, the goal is to show that
$\afix{A}{}{e} \simeq \afix{A'}{}{e'}$.

We analyze whether $\afix{A}{}{e}$ and $\afix{A'}{}{e'}$ diverge.
When both $\afix{A}{}{e}$ and $\afix{A'}{}{e'}$ diverge, the proof is trivial.
Otherwise, either $\afix{A}{}{e}$ converges or $\afix{A'}{}{e'}$ converges.
Suppose $\afix{A}{}{e}\longmapsto_*\overline{n}$.
By Compactness Theorem, $\afix{A}{m}{e} \longmapsto_*\overline{n}$ for some $m$.
By the assumption of the Generalized Fixed Point Induction and the definition of $\simeq$, we have $\afix{A'}{m}{e'} \longmapsto_*\overline{n}$.
By Inverse of Compactness, we can get $\afix{A'}{}{e'} \longmapsto_*\overline{n}$.
Since both $\afix{A}{}{e} \longmapsto_*\overline{n}$ and $\afix{A'}{}{e'} \longmapsto_*\overline{n}$ holds, we conclude the definition of $\simeq$.
For the remaining case that $\afix{A'}{}{e'}$ converges, the proof is symmetric.

\subsection{Proof of Inverse of Compactness}
\label{subsec:inverse}

%% Since the proof for Inverse of Compactness theorem is very technical,
%% please allow us to first give a informal intuition about
%% Compactness and Inverse of Compactness.

%% Consider $\omega$ as a machine which take steps to compute
%% the result of a function $F$
%% with input $e$.
%% In each step,
%% the machine may halt and get result $\overline{n}$ or continue computing.
%% We can construct a set $\mathbf{M}$ of clock machines $m_1, m_2,\dots, m_i, \dots$ simulating the behavior
%% of the machine $\omega$.
%% By clock machine, we mean that if machine $m_i$ cannot halt after $i$ steps, then it continue taking steps non-deterministically.
%% By simulating, we mean that in the first $i$ steps,
%% the step taken by clock machine $m_i$ is the same as the step taken by $\omega$.
%% Since $\mathbf{M}$ is enumerable ($f^{(m)}$ is defined by induction on natural number $m$),
%% there is a bijection $g$ between $\mathbf{N}$ and $\mathbf{M}$.
%% If $\omega$ halts, then it must halt after some finite $k$ steps.
%% We can always construct clock machine $g(k)=m_k$ (analogue to Compactness).
%% Conversely, if clock machine $m_k$ halts, it ensures that $\omega$ must halt within $g^{-1}(m_k)=k$ steps
%% (analogue to Inverse of Compactness).

% a step, each clock machine $m_i$ takes the same step.

%% Now we prove Inverse of Compactness theorem.
%% The overview of the proof is summaried in Fig.~\ref{fig-overview}.

%% \begin{figure}[htb]
%%   \centering
%%   \begin{tikzcd}[column sep=small]
%%     % \parbox{5cm}{\centering Fixed Point Induction} \ar[d] & \\
%%     \parbox{5cm}{\centering Inverse of Compactness} \ar[d] & \\
%%     \parbox{5cm}{\centering Generalized Inverse of Compactness} \ar[d] \ar[rd] & \\
%%     \parbox{5cm}{\centering Inverse of Compactness for Reduction \RNum{1}} & \parbox{5cm}{\centering Inverse of Compactness for Reduction \RNum{2}}\\
%%   \end{tikzcd}
%%   \caption{Proof of Inverse of Compactness}\label{fig-overview}
%% \end{figure}

Similar to the proof of Compactness Theorem in PFPL,
we prove Inverse of Compactness by proving
its generalized version described by using the stack machine for PCF:

\begin{lemma}[Generalized Inverse of Compactness]\label{lem:gcc}
  $\\$
  If $[f^{(m)}/y]k\triangleright[f^{(m)}/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$,
  then $[f^{(\omega)}/y]k\triangleright[f^{(\omega)}/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$.
\end{lemma}

The definitions of the stack machine are given in Chapter 28 of PFPL.
If Generalized Inverse of Compactness holds, we can the derive Inverse of Compactness
by first instantiating $k$ with the empty stack and then applying the soundness and completeness theorems
(in Chapter 28 of PFPL) which state that the reduction relation of terms is equivalent to the transition relation
in stack machines.

% \subsection{Overview}

% Now we propose our solution.
% The proof of fixed point induction is summaried in Fig.~\ref{fig-overview}.

% \begin{figure}[htb]
%   \centering
%   \begin{tikzcd}[column sep=small]
%     \parbox{5cm}{\centering Fixed Point Induction} \ar[d] & \\
%     \parbox{5cm}{\centering Inverse of Compactness} \ar[d] & \\
%     \parbox{5cm}{\centering Generalized Inverse of Compactness} \ar[d] \ar[rd] & \\
%     \parbox{5cm}{\centering Lemma~\ref{lem:B}} & \parbox{5cm}{\centering Lemma~\ref{lem:C}}\\
%   \end{tikzcd}
%   \caption{Proof of Fixed Point Induction}\label{fig-overview}
% \end{figure}

% We propose lemma Conversed Compactness to prove Fixed Point Induction.
% Conversed Compactness can be proved by its generalized version, which depends on Lemma~\ref{lem:B} and Lemma~\ref{lem:C}.
% We have formalized the proof in Coq.

% The detailed proof is illustrated in a top-down way as follows.
% First, we prove Fixed Point Induction by Conversed Compactness.
% Then, we prove Conversed Compactness.

% \subsection{Proof of Fixed Point Induction}

% The goal is to show $\afix{A}{}{e} \simeq \afix{A'}{}{e'}$.
% Our proof is by case analysis on the divergence of $\afix{A}{}{e}$ and $\afix{A'}{}{e'}$:

% \begin{enumerate}
%   \item Both $\afix{A}{}{e}$ and $\afix{A'}{}{e'}$ diverge
%   \item $\afix{A}{}{e}$ converges, but $\afix{A'}{}{e'}$ diverges
%   \item $\afix{A}{}{e}$ diverges, but $\afix{A'}{}{e'}$ converges
%   \item Both $\afix{A}{}{e}$ and $\afix{A'}{}{e'}$ converge
% \end{enumerate}

% The proof for Case 1 is straightforward by the definition of $\simeq$.
% Case 2 and Case 3 are equivalent because of the symmetry of $\simeq$.
% To prove Case 2 and Case 4, we propose the lemma, which we call it Conversed Compactness:

% % \begin{lemma}[Conversed Compactness] \label{lem:cc}
% %   $\\$
% %   If $[f^{(m)}/y]e\longmapsto_*\overline{n}$ for some $m$, then $[f^{(\omega)}/y]e\longmapsto_*\overline{n}$.
% % \end{lemma}

% Suppose Lemma~\ref{lem:cc} holds (we discuss its proof in Sec.~\ref{subsec:proof}).
% We can finish the proof for Case 2 and Case 4.
% The reasoning are the same for Case 2 and Case 4 as follows:

% Since $\afix{A}{}{e}$ converges, then $\afix{A}{}{e} \longmapsto_*\overline{n}$ for some $n$.
% By Compactness Theorem, $\afix{A}{m_1}{e} \longmapsto_*\overline{n}$ for some $m_1$.
% By the assumption of Fixed Point Induction, we have $\afix{A'}{m_1}{e'} \longmapsto_*\overline{n}$.
% By Conversed Compactness we can get $\afix{A'}{}{e'} \longmapsto_*\overline{n}$.
% Since both $\afix{A}{}{e} \longmapsto_*\overline{n}$ and $\afix{A'}{}{e'} \longmapsto_*\overline{n}$ holds,
% the goal is proved by the definition of $\simeq$.

% \subsection{Proof of Inverse of Compactness}
% \label{subsec:inverse}

% Similar to the proof of Compactness Theorem in PFPL,
% we prove the Conversed Compactness lemma by proving
% its generalized version, which is described by the stack machine for PCF.
% The definitions of the stack machine are the same as the definitions in Sec.28 of PFPL. 

% \begin{lemma}[Generalized Conversed Compactness]\label{lem:gcc}
%   $\\$
%   If $[f^{(m)}/y]k\triangleright[f^{(m)}/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$,
%   then $[f^{(\omega)}/y]k\triangleright[f^{(\omega)}/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$.
% \end{lemma}

The proof of Generalized Inverse of Compactness follows the proof of Lemma 47.15 in PFPL.
First by induction on $m$, and then induction on $\longmapsto_*$.

In the case that $m = 0$, the proof is similar to that of Lemma 47.15.
The reflexivity case of $\longmapsto_*$ is trivial ($\triangleright\neq \triangleleft$).
In the head case where $[f^{(0)}/y]k\triangleright[f^{(0)}/y]e\longmapsto s'$
and $s' \longmapsto_* \epsilon\triangleleft\overline{n}$ holds, we do case analysis on
the transition $[f^{(0)}/y]k\triangleright[f^{(0)}/y]e\longmapsto s'$.
The cases can be divided into two categories
according to the state of $s'$ (evaluation state, represented as $\triangleright$, or return state, represented as $\triangleleft$).
When $s'$ is a evaluation state, the goal is proved by the induction hypothesis for $\longmapsto_*$.
When $s'$ is a return state, the induction hypothesis for $\longmapsto_*$ cannot be directly applied
since it is only applicable for $\longmapsto_*$ with evaluation state on the left side.
However, the goal can be proved by further induction on the stack $k$ to get $s'\longmapsto s''$.
If $s''$ is still a return state, we apply induction hypothesis for the stack $k$;
if $s''$ turns out to be a evaluation state, we apply induction hypothesis for $\longmapsto_*$.

In the case where $m = S\;m'$,
we have the assumption that
$[([f^{(m')}/x]e_x)/y]k\triangleright[([f^{(m')}/x]e_x)/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$.
Syntactically, $[([f^{(m')}/x]e_x)/y]k = [f^{(m')}/x][e_x/y]k$ and $[([f^{(m')}/x]e_x)/y]e = [f^{(m')}/x][e_x/y]e$.
By induction hypothesis, we can get
$[([f^{(\omega)}/x]e_x)/y]k\triangleright[([f^{(\omega)}/x]e_x)/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$,
and we need to show $[f^{(\omega)}/y]k\triangleright[f^{(\omega)}/y]e\longmapsto_*\epsilon\triangleleft\overline{n}$.
%
It is proved by applying the following lemma with $m = f^{(\omega)}$, $m' = [f^{(\omega)}/x]e_x$ and $f^{(\omega)}\longmapsto[f^{(\omega)}/x]e_x$.
% \newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}

\begin{lemma}[Inverse of Compactness for Reduction \RNum{1}]\label{lem:B}
  Suppose that $m\longmapsto m'$.
  If $[m'/y]k\triangleright[m'/y]e\longmapsto_* \epsilon\triangleleft\overline{n}$,
  then $[m/y]k\triangleright[m/y]e\longmapsto_* \epsilon\triangleleft\overline{n}$.
\end{lemma}


Lemma~\ref{lem:B} cannot be proved alone. Instead, it is proved by together with Lemma~\ref{lem:C}:


\begin{lemma}[Inverse of Compactness for Reduction \RNum{2}]\label{lem:C}
  Suppose that $t\longmapsto t'$ and $m\longmapsto m'$.
  If $[m'/y]k\triangleright t'\longmapsto_* \epsilon\triangleleft\overline{n}$,
  then $[m/y]k\triangleright t\longmapsto_* \epsilon\triangleleft\overline{n}$.
\end{lemma}

Lemma~\ref{lem:B} and Lemma~\ref{lem:C} imply that
convergence of reduced terms implies convergence of the original terms.
These two lemmas are  proved by mutual induction on $\longmapsto_*$.
The intuition behind mutual induction is that after finite steps of transition,
the configuration in Lemma~\ref{lem:B} matches the configuration in Lemma~\ref{lem:C}
and vice versa.

In both lemmas, the reflexivity case is trivial ($\triangleright\neq \triangleleft$).

For the head case of Lemma~\ref{lem:B},
we have $[m'/y]k\triangleright[m'/y]e\longmapsto s'$
and $s' \longmapsto_* \epsilon\triangleleft\overline{n}$.
Similar to the proof of Lemma~\ref{lem:gcc}, we do case analysis on
the transition $[m'/y]k\triangleright[m'/y]e\longmapsto s'$.
Each case can be divided into two subcases according to whether $e = y$.
In the cases that $e = y$, the goal can be proved by applying Lemma~\ref{lem:C}.
Notice that if we give explicit steps for $\longmapsto_*$
and assume $[m'/y]k\triangleright t'\longmapsto_* \epsilon\triangleleft\overline{n}$ needs $i' + 1$ steps,
the steps for the instance of Lemma~\ref{lem:B} is also $i' + 1$.
In the cases that $e \neq y$, the proof is similar to Lemma~\ref{lem:gcc}.

For the head case of Lemma~\ref{lem:C},
we have $[m'/y]k\triangleright t' \longmapsto s'$
and $s' \longmapsto_* \epsilon\triangleleft\overline{n}$.
Similar to the proof of Lemma~\ref{lem:gcc}, we do case analysis on
the transition $[m'/y]k\triangleright t' \longmapsto s'$.
In each case, inversion the $t\longmapsto t'$ relation.
The subcases can be divided into two categories
according to whether the inversion produces sub-relation of $t\longmapsto t'$.
For example, if $t = S (e)$ and $t' = S (e')$ then the inversion produces the sub-relation $e\longmapsto e'$;
if $t = \mathit{ifz}(z;z;e)$ and $t' = z$ then the inversion does not produce sub-relation.
In the subcases where the inversion produces sub-relation, the goal can be proved by the induction hypothesis for $\longmapsto_*$
for the sub-relation $\longmapsto$.
In the subcases where the inversion does not produce sub-relation, the goal can be proved by Lemma~\ref{lem:B};
notice that if we give explicit steps for $\longmapsto_*$
and assume $[m'/y]k\triangleright t'\longmapsto_* \epsilon\triangleleft\overline{n}$ needs $i'+1$ steps,
the steps for the instance of Lemma~\ref{lem:B} is $i'$.

Combining the proof of Lemma~\ref{lem:B} and Lemma~\ref{lem:C}, the $\longmapsto_*$ relation is decreasing.
Therefore, the mutual induction is valid.

\section{Coq Formalization of Equality for PCF}

We have formalized the theorems in Chapter 47 of PFPL for proving that
contextual equivalence and logical equivalence imply each other in
Coq. The proof scripts are located at
\url{https://zenodo.org/records/13918934}. This formalization makes
use of a Coq library we developed for reasoning about the locally
nameless representation. The library extends the theory of Locally
Nameless Sets introduced by Andrew Pitts to generically and
automatically prove locally nameless lemmas. See the upcoming
paper ``Generic Reasoning of the Locally Nameless Representation'' in
APLAS 2024 for details.

\end{document}
